<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Complete Advanced Post Editor (Final Version)</title>
<style>
/* ------------------------------------------------------------- */
/* 1. ROOT VARIABLES & GENERAL STYLES */
/* ------------------------------------------------------------- */
:root{
    --blue:#007bff; /* Primary Blue from mainblog.html */
    --light:#f8f9fa; /* Light Gray Background */
    --panel:#fff; /* Editor Panel Background */
    --muted:#6c757d;
    --danger:#dc3545; /* Red for Delete/Apply CTA */
    --success:#28a745;
    --info:#17a2b8;
}
body{
    font-family:Arial, sans-serif; /* Adopted from mainblog.html */
    background:var(--light);
    margin:20px;
    color:#222;
    line-height:1.7; /* Increased line line-height for readability */
}
.page{
    max-width:1200px;
    margin:20px auto;
    background:var(--panel);
    padding:28px;
    border-radius:10px;
    box-shadow:0 6px 18px rgba(0,0,0,.08);
}

/* ------------------------------------------------------------- */
/* 2. EDITOR FORM ELEMENT STYLES */
/* ------------------------------------------------------------- */
input[type="text"],input[type="url"],input[type="number"]{width:100%;padding:10px;border:1px solid #d7d7d7;border-radius:6px;box-sizing:border-box;font-size:14px}
textarea{min-height:80px;resize:vertical;width:100%;padding:10px;border:1px solid #d7d7d7;border-radius:6px;box-sizing:border-box;font-size:14px;font-family:inherit}
.rich-editor{min-height:150px;border:1px solid #d7d7d7;border-radius:6px;padding:12px;background:#fff;max-height:500px;overflow-y:auto;line-height:1.8}
.rich-editor:focus{outline:2px solid var(--blue);outline-offset:2px}
.rich-editor:empty:before{content:attr(data-placeholder);color:#999}
.rich-editor ul,.rich-editor ol{margin:10px 0;padding-left:30px;list-style-position:outside}
.rich-editor ul{list-style-type:disc}
.rich-editor ol{list-style-type:decimal}
.rich-editor li{margin:6px 0;padding-left:5px}
.rich-editor p{margin:10px 0}
.rich-editor h1{font-size:28px;margin:16px 0 10px 0;font-weight:700}
.rich-editor h2{font-size:24px;margin:14px 0 8px 0;font-weight:600}
.rich-editor h3{font-size:20px;margin:12px 0 6px 0;font-weight:600}
.rich-editor strong,.rich-editor b{font-weight:700}
.rich-editor em,.rich-editor i{font-style:italic}
.rich-editor u{text-decoration:underline}
.toolbar{display:flex;gap:6px;flex-wrap:wrap;margin-bottom:8px;padding:10px;background:#f8f9fa;border-radius:6px;border:1px solid #e0e0e0}
.toolbar button{padding:7px 12px;border:1px solid #ddd;background:#fff;border-radius:4px;cursor:pointer;font-size:13px;transition:all 0.2s}
.toolbar button:hover{background:#e9ecef;border-color:#aaa}
.toolbar button.active{background:var(--blue);color:#fff;border-color:var(--blue)}
.toolbar-separator{width:1px;background:#ddd;margin:0 4px}
h1.title{color:var(--blue);margin:0 0 18px 0;font-size:26px}
h3.section-title{color:var(--blue);margin:0 0 10px 0;display:block;font-size:19px;font-weight:600;padding-right: 140px;}
.section{border:1px solid #e6e6e6;padding:18px;border-radius:8px;margin-bottom:18px;position:relative;background:#fff;box-shadow:0 2px 4px rgba(0,0,0,.03)}
.section-controls{position:absolute;right:12px;top:12px;display:flex;gap:4px;z-index:3}
.btn{cursor:pointer;border:0;padding:7px 10px;border-radius:6px;font-size:13px;color:#fff;transition:all 0.2s}
.btn:hover{opacity:0.9;transform:translateY(-1px)}
.btn.gray{background:var(--muted)}
.btn.updown{background:#8a8f96;padding: 7px 8px; font-size: 11px;}
.btn.edit{background:#007bff; padding: 7px 8px; font-size: 11px;}
.btn.delete{background:var(--danger); padding: 7px 8px; font-size: 11px;}
.btn.add{background:var(--success)}
.btn.remove{background:#ff6b6b}
table{width:100%;border-collapse:collapse;margin-top:10px}
th,td{border:1px solid #e0e0e0;padding:10px;text-align:left;vertical-align:middle}
th{background:#e3f2fd;font-weight:600;color:#0d47a1}
.add-section-bar{margin-bottom:20px;padding:16px;background:linear-gradient(135deg,#007bff 0%,#0056b3 100%); /* Updated gradient for new blue */
    border-radius:8px;display:flex;gap:10px;flex-wrap:wrap;box-shadow:0 4px 6px rgba(0,0,0,.1);position:relative}
.add-section-bar .btn{background:rgba(255,255,255,0.95);color:#007bff;font-weight:600}
.add-section-bar .btn:hover{background:#fff}
.small{font-size:13px;color:#555}
.restore-area{margin-top:20px;border:2px dashed #bdbdbd;padding:14px;border-radius:8px;background:#fbfbfb}
.restore-list{display:flex;gap:10px;flex-wrap:wrap;margin-top:10px}
.restore-item{background:#fff;border:1px solid #e5e5e5;padding:8px 10px;border-radius:6px;display:flex;gap:10px;align-items:center;box-shadow:0 2px 4px rgba(0,0,0,.05)}
.hidden{display:none}
.footer-actions{margin-top:24px;display:flex;gap:12px;flex-wrap:wrap}
.table-config{display:flex;gap:12px;margin-bottom:12px;align-items:center;padding:10px;background:#f8f9fa;border-radius:6px}
.table-config label{font-size:13px;font-weight:600}
.table-config input{width:80px;padding:6px}
.image-container{margin-top:10px}
.image-container img{max-width:100%;height:auto;border-radius:6px;margin-top:8px}
#actionButtonsContainer > div {
    display: flex;
    gap: 8px;
    margin-top: 8px;
    align-items: center;
    padding: 4px 0;
}
.btn-controls {
    display: flex;
    flex-direction: column;
    gap: 2px;
}
.btn-controls .btn {
    padding: 3px 6px;
    font-size: 11px;
    line-height: 1;
}

/* FIX: Cloning Dropdown Styling */
#cloneDropdown {
    position: absolute;
    /* Use 'left: 0' and 'top: 100%' relative to the parent button with 'position: relative' */
    top: 100%; 
    left: 0; 
    margin-top: 5px;
    background: #fff;
    border: 1px solid #ccc;
    border-radius: 6px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    z-index: 10;
    min-width: 250px;
    max-height: 300px;
    overflow-y: auto;
}
#cloneDropdown button {
    display: block;
    width: 100%;
    padding: 10px 15px;
    border: none;
    background: none;
    text-align: left;
    cursor: pointer;
    font-size: 14px;
    color: #333;
    transition: background 0.2s;
}
#cloneDropdown button:hover {
    background: #f0f0f0;
}
#cloneDropdown button:not(:last-child) {
    border-bottom: 1px solid #eee;
}

/* NEW: Font Size Dropdown Styling */
.toolbar select {
    padding: 6px 8px;
    border: 1px solid #ddd;
    border-radius: 4px;
    font-size: 13px;
    background: #fff;
    cursor: pointer;
    margin-right: 4px;
}
.toolbar select:focus {
    outline: none;
    border-color: var(--blue);
}

/* ------------------------------------------------------------- */
/* 3. PREVIEW AREA STYLES */
/* ------------------------------------------------------------- */
.preview-area{
    max-width: 1200px;
    margin: 20px auto;
    padding: 20px;
    background-color: var(--light); 
    border-radius: 8px;
    box-shadow: none; 
}
.preview-area .post-header-box {
    text-align: center;
    margin-bottom: 30px;
    padding: 20px;
    background-color: var(--blue); 
    color: white;
    border-radius: 8px;
}
.preview-area .post-header-box h1 {
    font-size: 2.2em;
    margin: 0 0 10px 0;
    color: white; 
}
.preview-area .themed-section {
    background-color: #ffffff;
    padding: 20px;
    border-radius: 8px;
    box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    border-left: 5px solid var(--blue); 
    margin-bottom: 25px;
}
.preview-area .themed-section h3 {
    color: var(--blue);
    margin-top: 0;
    padding-right: 0; 
}
.preview-area h2 {
    color: var(--blue); 
    border-bottom: 3px solid var(--blue);
    padding-bottom: 10px;
    margin-top: 40px;
    margin-bottom: 16px;
    font-size: 26px;
    font-weight: 600;
}
.preview-area h3 {
    color: #222; 
    font-size: 22px;
    margin: 16px 0 8px 0;
    font-weight: 600;
}
.preview-area h1{font-size:32px;margin:20px 0 14px 0;font-weight:700;color:#1a1a1a}
.preview-area p{margin:12px 0;line-height:1.7}
.preview-area ul, .preview-area ol{
    padding-left: 20px;
    margin: 10px 0;
}
.preview-area li{
    margin-bottom: 8px;
    line-height: 1.7;
}
.preview-area table{width:100%;border-collapse:collapse;margin:15px 0}
.preview-area th, .preview-area td{border:1px solid #ddd;padding:12px;text-align:left;vertical-align:middle}
.preview-area th{
    background:#e9f5ff; 
    font-weight:700;
    color:var(--blue);
    border-top: 3px solid var(--blue); 
}
.preview-area .action-button-group {
    text-align: center;
    margin: 20px 0 10px 0;
    padding: 15px;
    background-color: #fff;
    border: 1px solid #eee;
    border-radius: 8px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.05);
}
.preview-area .apply-button {
    display: inline-block;
    background: var(--danger); 
    color: #fff;
    padding: 12px 24px;
    border-radius: 6px;
    text-decoration: none;
    font-weight: 700;
    margin: 8px;
    font-size: 16px;
    transition: all 0.2s;
}
.preview-area .apply-button:hover {
    background: #c82333;
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(0,0,0,0.1);
}
.preview-area a {
    color: var(--blue);
    text-decoration: none;
}
.preview-area a:hover {
    text-decoration: underline;
}
</style>
</head>
<body>
<div class="page">
<h1 class="title">üìù Complete Advanced Post Editor (Final Version)</h1>
<div style="margin-bottom:16px">
<input id="postTitle" type="text" placeholder="Enter Post Title (Job/Blog/Article)"/>
</div>
<div class="add-section-bar" id="addSectionBar">
<button class="btn" onclick="addRichTextSection()">üìÑ Rich Text</button>
<button class="btn" onclick="addCustomTable()">üìä Custom Table</button>
<button class="btn" onclick="addImageSection()">üñºÔ∏è Image</button>
<button class="btn" onclick="addSimpleTextSection()">üìù Simple Text</button>
<button class="btn" style="position:relative;" onclick="cloneSectionDialog(this)">üîÑ Clone Existing Section</button>
</div>
<div id="sectionsContainer">

<div class="section" id="sec_details" data-default-title="Notification Details" data-type="richtext">
    <div class="section-controls">
        <button class="btn updown" onclick="moveSection(this,'up')">‚Üë</button>
        <button class="btn updown" onclick="moveSection(this,'down')">‚Üì</button>
        <button class="btn edit" onclick="editTitle(this)">‚úèÔ∏è</button>
        <button class="btn delete" onclick="deleteSection(this)">üóëÔ∏è</button>
    </div>
<h3 class="section-title">Notification Details</h3>
<div class="toolbar">
<select onchange="formatDoc('formatBlock', this.value, this)">
    <option value="<p>">Size 2 (Default)</option>
    <option value="<h1>">Size 5 (Largest)</option>
    <option value="<h2>">Size 4</option>
    <option value="<h3>">Size 3</option>
</select>
<button onmousedown="event.preventDefault(); formatDoc('bold', null, this)"><b>B</b></button>
<button onmousedown="event.preventDefault(); formatDoc('italic', null, this)"><i>I</i></I></button>
<button onmousedown="event.preventDefault(); formatDoc('underline', null, this)"><u>U</u></button>
<span class="toolbar-separator"></span>
<button onmousedown="event.preventDefault(); formatDoc('insertUnorderedList', null, this)">‚Ä¢ List</button>
<button onmousedown="event.preventDefault(); formatDoc('insertOrderedList', null, this)">1. List</button>
<span class="toolbar-separator"></span>
<button onmousedown="event.preventDefault(); formatDoc('removeFormat', null, this)">Clear</button>
</div>
<div class="rich-editor sec-content" contenteditable="true" data-placeholder="Enter main notification details or introduction..."></div>
</div>
<div class="section" id="sec_about" data-default-title="About" data-type="richtext">
    <div class="section-controls">
        <button class="btn updown" onclick="moveSection(this,'up')">‚Üë</button>
        <button class="btn updown" onclick="moveSection(this,'down')">‚Üì</button>
        <button class="btn edit" onclick="editTitle(this)">‚úèÔ∏è</button>
        <button class="btn delete" onclick="deleteSection(this)">üóëÔ∏è</button>
    </div>
<h3 class="section-title">About</h3>
<div class="toolbar">
<select onchange="formatDoc('formatBlock', this.value, this)">
    <option value="<p>">Size 2 (Default)</option>
    <option value="<h1>">Size 5 (Largest)</option>
    <option value="<h2>">Size 4</option>
    <option value="<h3>">Size 3</option>
</select>
<button onmousedown="event.preventDefault(); formatDoc('bold', null, this)"><b>B</b></button>
<button onmousedown="event.preventDefault(); formatDoc('italic', null, this)"><i>I</i></I></button>
<button onmousedown="event.preventDefault(); formatDoc('underline', null, this)"><u>U</u></button>
<span class="toolbar-separator"></span>
<button onmousedown="event.preventDefault(); formatDoc('insertUnorderedList', null, this)">‚Ä¢ List</button>
<button onmousedown="event.preventDefault(); formatDoc('insertOrderedList', null, this)">1. List</button>
<span class="toolbar-separator"></span>
<button onmousedown="event.preventDefault(); formatDoc('removeFormat', null, this)">Clear</button>
</div>
<div class="rich-editor sec-content" contenteditable="true" data-placeholder="Write content... Paste from anywhere!"></div>
</div>
<div class="section" id="sec_dates" data-default-title="Important Dates" data-type="table">
    <div class="section-controls">
        <button class="btn updown" onclick="moveSection(this,'up')">‚Üë</button>
        <button class="btn updown" onclick="moveSection(this,'down')">‚Üì</button>
        <button class="btn edit" onclick="editTitle(this)">‚úèÔ∏è</button>
        <button class="btn delete" onclick="deleteSection(this)">üóëÔ∏è</button>
    </div>
<h3 class="section-title">Important Dates</h3>
<table><thead><tr><th>Event</th><th>Date</th><th style="width:90px">Action</th></tr></thead>
<tbody>
<tr>
<td><input type="text" placeholder="Event"></td>
<td><input type="text" placeholder="Date"></td>
<td><button class="btn add" onclick="addRow(this)">+</button></td>
</tr>
</tbody>
</table>
</div>
<div class="section" id="sec_fee" data-default-title="Application Fee" data-type="table">
    <div class="section-controls">
        <button class="btn updown" onclick="moveSection(this,'up')">‚Üë</button>
        <button class="btn updown" onclick="moveSection(this,'down')">‚Üì</button>
        <button class="btn edit" onclick="editTitle(this)">‚úèÔ∏è</button>
        <button class="btn delete" onclick="deleteSection(this)">üóëÔ∏è</button>
    </div>
<h3 class="section-title">Application Fee</h3>
<table><thead><tr><th>Category</th><th>Fee (‚Çπ)</th><th style="width:90px">Action</th></tr></thead>
<tbody>
<tr>
<td><input type="text" placeholder="Category"></td>
<td><input type="text" placeholder="Fee"></td>
<td><button class="btn add" onclick="addRow(this)">+</button></td>
</tr>
</tbody>
</table>
</div>
<div class="section" id="sec_eligibility" data-default-title="Eligibility" data-type="richtext">
    <div class="section-controls">
        <button class="btn updown" onclick="moveSection(this,'up')">‚Üë</button>
        <button class="btn updown" onclick="moveSection(this,'down')">‚Üì</button>
        <button class="btn edit" onclick="editTitle(this)">‚úèÔ∏è</button>
        <button class="btn delete" onclick="deleteSection(this)">üóëÔ∏è</button>
    </div>
<h3 class="section-title">Eligibility</h3>
<div class="toolbar">
<select onchange="formatDoc('formatBlock', this.value, this)">
    <option value="<p>">Size 2 (Default)</option>
    <option value="<h1>">Size 5 (Largest)</option>
    <option value="<h2>">Size 4</option>
    <option value="<h3>">Size 3</option>
</select>
<button onmousedown="event.preventDefault(); formatDoc('bold', null, this)"><b>B</b></button>
<button onmousedown="event.preventDefault(); formatDoc('italic', null, this)"><i>I</i></I></button>
<button onmousedown="event.preventDefault(); formatDoc('underline', null, this)"><u>U</u></button>
<span class="toolbar-separator"></span>
<button onmousedown="event.preventDefault(); formatDoc('insertUnorderedList', null, this)">‚Ä¢ List</button>
<button onmousedown="event.preventDefault(); formatDoc('insertOrderedList', null, this)">1. List</button>
<span class="toolbar-separator"></span>
<button onmousedown="event.preventDefault(); formatDoc('removeFormat', null, this)">Clear</button>
</div>
<div class="rich-editor sec-content" contenteditable="true" data-placeholder="Enter eligibility..."></div>
</div>
<div class="section" id="sec_vacancy" data-default-title="Vacancy Details" data-type="table">
    <div class="section-controls">
        <button class="btn updown" onclick="moveSection(this,'up')">‚Üë</button>
        <button class="btn updown" onclick="moveSection(this,'down')">‚Üì</button>
        <button class="btn edit" onclick="editTitle(this)">‚úèÔ∏è</button>
        <button class="btn delete" onclick="deleteSection(this)">üóëÔ∏è</button>
    </div>
<h3 class="section-title">Vacancy Details</h3>
<table><thead><tr><th>Discipline</th><th>Posts</th><th style="width:90px">Action</th></tr></thead>
<tbody>
<tr>
<td><input type="text" placeholder="Discipline"></td>
<td><input type="text" placeholder="Posts"></td>
<td><button class="btn add" onclick="addRow(this)">+</button></td>
</tr>
</tbody>
</table>
</div>
<div class="section" id="sec_exam" data-default-title="Exam Pattern" data-type="richtext">
    <div class="section-controls">
        <button class="btn updown" onclick="moveSection(this,'up')">‚Üë</button>
        <button class="btn updown" onclick="moveSection(this,'down')">‚Üì</button>
        <button class="btn edit" onclick="editTitle(this)">‚úèÔ∏è</button>
        <button class="btn delete" onclick="deleteSection(this)">üóëÔ∏è</button>
    </div>
<h3 class="section-title">Exam Pattern</h3>
<div class="toolbar">
<select onchange="formatDoc('formatBlock', this.value, this)">
    <option value="<p>">Size 2 (Default)</option>
    <option value="<h1>">Size 5 (Largest)</option>
    <option value="<h2>">Size 4</option>
    <option value="<h3>">Size 3</option>
</select>
<button onmousedown="event.preventDefault(); formatDoc('bold', null, this)"><b>B</b></button>
<button onmousedown="event.preventDefault(); formatDoc('italic', null, this)"><i>I</i></I></button>
<button onmousedown="event.preventDefault(); formatDoc('underline', null, this)"><u>U</u></button>
<span class="toolbar-separator"></span>
<button onmousedown="event.preventDefault(); formatDoc('insertUnorderedList', null, this)">‚Ä¢ List</button>
<button onmousedown="event.preventDefault(); formatDoc('insertOrderedList', null, this)">1. List</button>
<span class="toolbar-separator"></span>
<button onmousedown="event.preventDefault(); formatDoc('removeFormat', null, this)">Clear</button>
</div>
<div class="rich-editor sec-content" contenteditable="true" data-placeholder="Enter exam pattern details (e.g., Tier 1: Subject, Marks, Time)..."></div>
</div>
<div class="section" id="sec_pay" data-default-title="Pay Structure" data-type="table">
    <div class="section-controls">
        <button class="btn updown" onclick="moveSection(this,'up')">‚Üë</button>
        <button class="btn updown" onclick="moveSection(this,'down')">‚Üì</button>
        <button class="btn edit" onclick="editTitle(this)">‚úèÔ∏è</button>
        <button class="btn delete" onclick="deleteSection(this)">üóëÔ∏è</button>
    </div>
<h3 class="section-title">Pay Structure</h3>
<table><thead><tr><th>Grade/Level</th><th>Pay Scale (‚Çπ)</th><th>Grade Pay (‚Çπ)</th><th style="width:90px">Action</th></tr></thead>
<tbody>
<tr>
<td><input type="text" placeholder="Grade"></td>
<td><input type="text" placeholder="Pay Scale"></td>
<td><input type="text" placeholder="Grade Pay"></td>
<td><button class="btn add" onclick="addRow(this)">+</button></td>
</tr>
</tbody>
</table>
</div>
<div class="section" id="sec_buttons" data-default-title="Action Buttons" data-type="buttons">
    <div class="section-controls">
        <button class="btn updown" onclick="moveSection(this,'up')">‚Üë</button>
        <button class="btn updown" onclick="moveSection(this,'down')">‚Üì</button>
        <button class="btn edit" onclick="editTitle(this)">‚úèÔ∏è</button>
        <button class="btn delete" onclick="deleteSection(this)">üóëÔ∏è</button>
    </div>
<h3 class="section-title">Action Buttons</h3>
<div id="actionButtonsContainer"></div>
<div style="margin-top:8px">
<button class="btn add" onclick="addActionButton()">+ Add Button</button>
</div>
<div class="small">Buttons with custom labels & links</div>
</div>
</div>
<div class="restore-area">
<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
<strong>‚ôªÔ∏è Restore Deleted</strong>
<span class="small">Deleted sections here</span>
</div>
<div class="restore-list" id="restoreList"></div>
</div>
<div class="footer-actions">
<button class="btn edit" style="background:#0b5ed7" onclick="previewPost()">üëÅÔ∏è Preview</button>
<button class="btn" style="background:#28a745" onclick="downloadHTML()">‚¨áÔ∏è Download HTML</button>
<button class="btn gray" onclick="location.reload()">üîÑ Reset</button>
</div>
<div id="preview" class="preview-area hidden"></div>
</div>
<script>
// --- GLOBAL TEMPLATES ---
const universalControlsHTML = `
    <div class="section-controls">
        <button class="btn updown" onclick="moveSection(this,'up')">‚Üë</button>
        <button class="btn updown" onclick="moveSection(this,'down')">‚Üì</button>
        <button class="btn edit" onclick="editTitle(this)">‚úèÔ∏è</button>
        <button class="btn delete" onclick="deleteSection(this)">üóëÔ∏è</button>
    </div>
`;

// UPDATED: Rich Text Toolbar with Size Dropdown
const richTextToolbarHTML = `
    <div class="toolbar">
        <select onchange="formatDoc('formatBlock', this.value, this)">
            <option value="<p>">Size 2 (Default)</option>
            <option value="<h1>">Size 5 (Largest)</option>
            <option value="<h2>">Size 4</option>
            <option value="<h3>">Size 3</option>
        </select>
        <button onmousedown="event.preventDefault(); formatDoc('bold', null, this)"><b>B</b></button>
        <button onmousedown="event.preventDefault(); formatDoc('italic', null, this)"><i>I</i></I></button>
        <button onmousedown="event.preventDefault(); formatDoc('underline', null, this)"><u>U</u></button>
        <span class="toolbar-separator"></span>
        <button onmousedown="event.preventDefault(); formatDoc('insertUnorderedList', null, this)">‚Ä¢ List</button>
        <button onmousedown="event.preventDefault(); formatDoc('insertOrderedList', null, this)">1. List</button>
        <span class="toolbar-separator"></span>
        <button onmousedown="event.preventDefault(); formatDoc('removeFormat', null, this)">Clear</button>
    </div>
`;

// NEW: UNIVERSAL FOOTER
const UNIVERSAL_FOOTER = `
<footer style="
    all: initial;
    display: block;
    width: 100%;
    text-align: center;
    padding: 15px 10px;
    background-color: #2c3e50;
    color: #ffffff;
    font-family: Arial, Helvetica, sans-serif;
    font-size: 14px;
    box-sizing: border-box;
">
    <p style="all: unset; display: inline; color: #ffffff;">
        &copy; 2025 <strong>Rozgardesk</strong>. All rights reserved. 
        <a href='../privacypolicy.html' 
            style='all: unset; color:#ffffff; cursor:pointer; text-decoration:none; font-weight:500;'
            onmouseover='this.style.textDecoration="underline";'
            onmouseout='this.style.textDecoration="none";'>
            Privacy Policy
        </a> |
        <a href='../aboutus.html'
            style='all: unset; color:#ffffff; cursor:pointer; text-decoration:none; font-weight:500;'
            onmouseover='this.style.textDecoration="underline";'
            onmouseout='this.style.textDecoration="none";'>
            About Us
        </a>
    </p>
</footer>
`;


// --- CORE FUNCTIONALITY ---

// Rich Text Formatting - FIX APPLIED HERE
function formatDoc(command, value, element) {
    // 1. Find the editable content area
    const editor = element.closest('.section').querySelector('.rich-editor');

    // 2. Explicitly ensure the editor has focus
    editor.focus();

    // 3. Execute command with error handling
    try {
        // Use document.execCommand (deprecated, but necessary for contenteditable)
        // If command is formatBlock and value is <p>, use 'p'
        const commandValue = (command === 'formatBlock' && value === '<p>') ? 'p' : value;

        document.execCommand(command, false, commandValue);
        
        // After formatBlock, we need to reset the select element's value if it's a dropdown
        if (command === 'formatBlock' && element.tagName === 'SELECT') {
             // We don't need to reset it, as the select element should retain the chosen value
        }

    } catch (e) {
        console.error("Error executing execCommand:", e);
    }

    // 4. Update the toolbar state (for bold/italic/underline toggles)
    updateToolbarState(editor);
}

// Function to update the toolbar active state
function updateToolbarState(editor){
    const toolbar = editor.previousElementSibling;
    if(!toolbar || !toolbar.classList.contains('toolbar')) return;
    toolbar.querySelectorAll('button').forEach(button => {
        button.classList.remove('active');
        // Check command state for toggle buttons
        const commandText = button.getAttribute('onmousedown');
        if (commandText) {
            if (commandText.includes("('bold'") && document.queryCommandState('bold')) {
                button.classList.add('active');
            } else if (commandText.includes("('italic'") && document.queryCommandState('italic')) {
                button.classList.add('active');
            } else if (commandText.includes("('underline'") && document.queryCommandState('underline')) {
                button.classList.add('active');
            }
        }
    });
}

// Universal Section Movement
function moveSection(b,d){
    const s=b.closest('.section'),c=document.getElementById('sectionsContainer');
    if(d==='up'&&s.previousElementSibling)c.insertBefore(s,s.previousElementSibling);
    else if(d==='down'&&s.nextElementSibling)c.insertBefore(s.nextElementSibling,s)
}

// Universal Title Editing
function editTitle(b){
    const s=b.closest('.section'),h=s.querySelector('.section-title');
    // Ensure the title is always treated as text before editing
    const currentTitle = h.innerText;
    const i=document.createElement('input');
    i.type='text';
    i.value=currentTitle;
    i.style.width='70%';
    i.style.fontSize='18px';
    i.style.padding='5px';
    i.style.margin='0';
    h.innerText=''; // Clear the title text
    h.appendChild(i); // Append the input
    const saveTitle = () => {
        const newTitle = i.value.trim() || s.dataset.defaultTitle || 'Section';
        h.innerText = newTitle;
        // Update default title attribute for cloning/reset
        s.setAttribute('data-default-title', newTitle);
        i.removeEventListener('blur', saveTitle);
        i.removeEventListener('keypress', handleKeyPress);
    };
    const handleKeyPress = (e) => {
        if(e.key==='Enter') i.blur(); // Trigger blur to save
    };
    i.addEventListener('blur', saveTitle);
    i.addEventListener('keypress', handleKeyPress);
    i.focus();
    i.select();
}

// Section Deletion and Restore
let deletedStore=[];
function deleteSection(b){
    const s=b.closest('.section'),id=s.id||('sec_'+Date.now());s.id=id;
    const cl=s.cloneNode(true); 
    
    // Manually capture dynamic content (rich editor innerHTML, input values)
    s.querySelectorAll('.rich-editor').forEach((sr,i)=>{
        if(cl.querySelectorAll('.rich-editor')[i]) cl.querySelectorAll('.rich-editor')[i].innerHTML = sr.innerHTML;
    });
    s.querySelectorAll('input,textarea').forEach((sr,i)=>{
        if(cl.querySelectorAll('input,textarea')[i] && sr.type !== 'button') { 
            cl.querySelectorAll('input,textarea')[i].value = sr.value;
        }
    });

    const ti=s.querySelector('.section-title')?.innerText||s.dataset.defaultTitle||'Section';
    deletedStore.push({id,html:cl.outerHTML,title:ti});
    s.remove();
    refreshRestoreUI();
}
function refreshRestoreUI(){
    const l=document.getElementById('restoreList');l.innerHTML='';
    deletedStore.forEach(i=>{
        const d=document.createElement('div');d.classList.add('restore-item');
        d.innerHTML=`<span>${i.title}</span><button class="btn success" onclick="restoreSection('${i.id}')">Restore</button>`;
        l.appendChild(d);
    });
}
function restoreSection(id){
    const i=deletedStore.findIndex(item=>item.id===id);
    if(i>-1){
        const item=deletedStore.splice(i,1)[0];
        document.getElementById('sectionsContainer').insertAdjacentHTML('beforeend',item.html);
        
        // Re-attach listeners for rich text and images
        const restoredSection = document.getElementById(id);
        restoredSection.querySelectorAll('.rich-editor').forEach(e => {
            e.addEventListener('keyup', () => updateToolbarState(e));
            e.addEventListener('mouseup', () => updateToolbarState(e));
        });
        restoredSection.querySelectorAll('.sec-url').forEach(e => {
            e.addEventListener('input', updateImagePreview);
            // Manually trigger preview update if a URL exists
            if (e.value) updateImagePreview({ target: e });
        });

        refreshRestoreUI();
    }
}

// --- SECTION ADDERS ---
let sectionCounter = 0;

// 1. Rich Text Section
function addRichTextSection(){
    sectionCounter++;
    const id = `sec_rich_${Date.now()}`;
    const defaultTitle = `Rich Content Section ${sectionCounter}`;
    const html = `
        <div class="section" id="${id}" data-default-title="${defaultTitle}" data-type="richtext">
            ${universalControlsHTML}
            <h3 class="section-title">${defaultTitle}</h3>
            ${richTextToolbarHTML}
            <div class="rich-editor sec-content" contenteditable="true" data-placeholder="Enter content here..."></div>
        </div>
    `;
    document.getElementById('sectionsContainer').insertAdjacentHTML('beforeend', html);
    // Attach event listeners for rich text
    document.getElementById(id).querySelector('.rich-editor').addEventListener('keyup', (e) => updateToolbarState(e.target));
    document.getElementById(id).querySelector('.rich-editor').addEventListener('mouseup', (e) => updateToolbarState(e.target));
}

// 2. Custom Table Section
function addCustomTable(){
    sectionCounter++;
    const id = `sec_table_${Date.now()}`;
    const defaultTitle = `Custom Table ${sectionCounter}`;
    // Default to 3 columns: Col 1, Col 2, Col 3 + Action Column
    const html = `
        <div class="section" id="${id}" data-default-title="${defaultTitle}" data-type="table">
            ${universalControlsHTML}
            <h3 class="section-title">${defaultTitle}</h3>
            <div class="table-config">
                <label for="colCount_${id}">Columns (excl. Action):</label>
                <input type="number" id="colCount_${id}" value="3" min="1" max="10" onchange="createTableFromConfig(this)">
            </div>
            <table>
                <thead>
                    <tr>
                        <th><input type="text" value="Column 1"></th>
                        <th><input type="text" value="Column 2"></th>
                        <th><input type="text" value="Column 3"></th>
                        <th style="width:90px">Action</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td><input type="text" placeholder="Data 1"></td>
                        <td><input type="text" placeholder="Data 2"></td>
                        <td><input type="text" placeholder="Data 3"></td>
                        <td><button class="btn add" onclick="addRow(this)">+</button></td>
                    </tr>
                </tbody>
            </table>
        </div>
    `;
    document.getElementById('sectionsContainer').insertAdjacentHTML('beforeend', html);
}
function createTableFromConfig(input){
    const s = input.closest('.section');
    const count = Math.min(Math.max(parseInt(input.value) || 1, 1), 10); // Clamp between 1 and 10
    input.value = count;
    const table = s.querySelector('table');
    
    let newHeadHTML = '';
    for(let i=1; i<=count; i++){
        newHeadHTML += `<th><input type="text" value="Column ${i}"></th>`;
    }
    newHeadHTML += '<th style="width:90px">Action</th>';
    table.querySelector('thead tr').innerHTML = newHeadHTML;

    // Preserve first row content if possible, otherwise create a blank row
    let firstRow = table.querySelector('tbody tr');
    let newBodyRowHTML = '<tr>';
    for(let i=1; i<=count; i++){
        // If the old row had content, try to use it
        const oldValue = firstRow && firstRow.children[i-1] && firstRow.children[i-1].querySelector('input') ? 
                         firstRow.children[i-1].querySelector('input').value : 
                         '';
        newBodyRowHTML += `<td><input type="text" placeholder="Data ${i}" value="${oldValue}"></td>`;
    }
    newBodyRowHTML += `<td><button class="btn add" onclick="addRow(this)">+</button></td></tr>`;
    
    table.querySelector('tbody').innerHTML = newBodyRowHTML;
}

// Table Row Management
function addRow(b){
    const r=b.closest('tr'),t=r.closest('tbody');
    const c=r.cloneNode(true);
    c.querySelectorAll('input').forEach(i=>i.value='');
    c.querySelector('.btn.add')?.remove(); 
    c.querySelector('td:last-child').innerHTML=`<button class="btn remove" onclick="deleteRow(this)">-</button>`;
    t.appendChild(c);
}
function deleteRow(b){const r=b.closest('tr');if(r.closest('tbody').childElementCount>1)r.remove()}

// 3. Image Section
function addImageSection(){
    sectionCounter++;
    const id = `sec_image_${Date.now()}`;
    const defaultTitle = `Image/Media ${sectionCounter}`;
    const html = `
        <div class="section" id="${id}" data-default-title="${defaultTitle}" data-type="image">
            ${universalControlsHTML}
            <h3 class="section-title">${defaultTitle}</h3>
            <input type="url" class="sec-url" placeholder="Enter Image URL (e.g. https://...)">
            <textarea class="sec-caption" placeholder="Enter image caption/alt text..."></textarea>
            <div class="image-container"></div>
            <div class="small" style="margin-top:10px">Preview will show after entering a valid URL.</div>
        </div>
    `;
    document.getElementById('sectionsContainer').insertAdjacentHTML('beforeend', html);
    const urlInput = document.getElementById(id).querySelector('.sec-url');
    urlInput.addEventListener('input', updateImagePreview);
}
function updateImagePreview(e){
    const url = e.target.value.trim();
    const container = e.target.closest('.section').querySelector('.image-container');
    
    if (url.match(/\.(jpeg|jpg|gif|png|webp|svg)$/i)) {
        container.innerHTML = `<img src="${url}" alt="Image Preview" onerror="this.style.display='none'">`;
    } else {
        container.innerHTML = '';
    }
}

// 4. Simple Text Section
function addSimpleTextSection(){
    sectionCounter++;
    const id = `sec_simple_${Date.now()}`;
    const defaultTitle = `Simple Text Block ${sectionCounter}`;
    const html = `
        <div class="section" id="${id}" data-default-title="${defaultTitle}" data-type="simpletext">
            ${universalControlsHTML}
            <h3 class="section-title">${defaultTitle}</h3>
            <textarea class="sec-content" placeholder="Enter simple text... No formatting."></textarea>
        </div>
    `;
    document.getElementById('sectionsContainer').insertAdjacentHTML('beforeend', html);
}

// 5. Action Button Management
function addActionButton(defaultLabel = 'Button Label', defaultUrl = ''){
    const container = document.getElementById('actionButtonsContainer');
    const id = `btn_row_${Date.now()}`;
    const html = `
        <div id="${id}">
            <input type="text" class="btn-label" value="${defaultLabel}" style="width: 200px;" placeholder="Button Label (e.g., Apply Now)">
            <input type="url" class="btn-url" value="${defaultUrl}" style="flex-grow: 1;" placeholder="Link URL (e.g., https://...)">
            <div class="btn-controls">
                <button class="btn updown" onclick="moveActionButton(this, 'up')">‚Üë</button>
                <button class="btn updown" onclick="moveActionButton(this, 'down')">‚Üì</button>
            </div>
            <button class="btn remove" onclick="deleteActionButton(this)">-</button>
        </div>
    `;
    container.insertAdjacentHTML('beforeend', html);
}
function deleteActionButton(b){ b.closest('div').remove(); }
function moveActionButton(b,d){
    const r=b.closest('div'),c=r.closest('#actionButtonsContainer');
    if(d==='up'&&r.previousElementSibling)c.insertBefore(r,r.previousElementSibling);
    else if(d==='down'&&r.nextElementSibling)c.insertBefore(r.nextElementSibling,r)
}

// --- CLONING FUNCTIONALITY (FIXED) ---
function cloneSectionDialog(triggerButton) {
    const sections = document.querySelectorAll('#sectionsContainer .section');
    if (sections.length === 0) {
        alert("No sections to clone yet.");
        return;
    }

    // 1. Remove any existing dropdown to prevent duplicates
    document.getElementById('cloneDropdown')?.remove();
    
    // 2. Create and populate the new dropdown
    const dropdown = document.createElement('div');
    dropdown.id = 'cloneDropdown';
    
    sections.forEach((section, index) => {
        const title = section.querySelector('.section-title')?.innerText || section.dataset.defaultTitle || `Section ${index + 1}`;
        const id = section.id || `temp_id_${Date.now()}_${index}`; 
        section.id = id; // Ensure ID is present for cloning reference
        
        const button = document.createElement('button');
        button.innerText = `Clone: ${title}`;
        button.onclick = (e) => {
            e.preventDefault();
            cloneSection(id);
            dropdown.remove(); // Close after cloning
        };
        dropdown.appendChild(button);
    });

    // 3. Position the dropdown relative to the trigger button
    triggerButton.appendChild(dropdown);
}

function cloneSection(originalId) {
    const originalSection = document.getElementById(originalId);
    if (!originalSection) return;

    // 1. Manually capture the current state of the original section
    // Use innerHTML to capture current table rows/content
    const clonedSection = originalSection.cloneNode(true);

    // 2. Generate new unique ID and update attributes
    const newId = `sec_clone_${Date.now()}`;
    clonedSection.id = newId;
    
    // 3. Reset specific content for the clone and ensure it is not referencing old IDs
    // Rich Text: Must clear content
    clonedSection.querySelectorAll('.rich-editor').forEach(editor => {
        editor.innerHTML = ''; 
    });
    // Simple Text/Image: Must clear textareas/inputs
    clonedSection.querySelectorAll('textarea.sec-content, input.sec-url, textarea.sec-caption').forEach(input => {
        input.value = '';
    });
    // Image: Clear preview container
    clonedSection.querySelector('.image-container')?.remove();

    // Tables: Keep the structure, clear the data inputs
    clonedSection.querySelectorAll('table input[type="text"]').forEach(input => {
        // Keep header inputs, clear body inputs
        if (input.closest('tbody')) {
            input.value = '';
        }
    });

    // Action Buttons: Clear inputs
    clonedSection.querySelectorAll('#actionButtonsContainer input').forEach(input => {
        input.value = '';
    });
    
    // 4. Update section title
    const originalTitle = originalSection.dataset.defaultTitle || originalSection.querySelector('.section-title').innerText;
    const newTitle = `(CLONED) ${originalTitle}`;
    clonedSection.querySelector('.section-title').innerText = newTitle;
    clonedSection.setAttribute('data-default-title', newTitle);

    // 5. Append to container
    document.getElementById('sectionsContainer').appendChild(clonedSection);

    // 6. Re-attach listeners for cloned rich editor and image url input
    const newSection = document.getElementById(newId);
    newSection.querySelectorAll('.rich-editor').forEach(e => {
        e.addEventListener('keyup', () => updateToolbarState(e));
        e.addEventListener('mouseup', () => updateToolbarState(e));
    });

    newSection.querySelectorAll('.sec-url').forEach(e => {
        e.addEventListener('input', updateImagePreview);
    });
}


// --- PREVIEW & DOWNLOAD ---

// Function to generate the HTML for the post content inside the preview container
function generatePostContent(isDownload = false) {
    const sectionsContainer = document.getElementById('sectionsContainer');
    let postTitle = document.getElementById('postTitle').value.trim() || 'Untitled Post - Govt Job Notification';
    
    // START: THEMED HEADER
    let previewContent = `
        <div class="post-header-box">
            <h1 style="font-size: 2.2em; margin: 0 0 10px 0; color: white;">
                <strong>${postTitle}</strong>
            </h1>
            <p style="font-size: 1.1em; opacity: 0.9; margin: 0;">Latest Update from RozgarDesk.in</p>
        </div>
    `;
    // END: THEMED HEADER

    sectionsContainer.querySelectorAll('.section').forEach(section => {
        const sectionType = section.dataset.type;
        let title = section.querySelector('.section-title').innerText;
        let contentHTML = '';

        if (sectionType === 'richtext') {
            const content = section.querySelector('.rich-editor').innerHTML.trim();
            if (content) {
                // Apply the 'Job Card' look to rich text
                contentHTML = `
                    <div class="themed-section">
                        <h3>${title}</h3>
                        <div class="section-body">${content}</div>
                    </div>
                `;
            }
        } else if (sectionType === 'simpletext') {
            const content = section.querySelector('.sec-content').value.trim().replace(/\n/g, '<br>');
            if (content) {
                // Apply the 'Job Card' look to simple text
                contentHTML = `
                    <div class="themed-section">
                        <h3>${title}</h3>
                        <p>${content}</p>
                    </div>
                `;
            }
        } else if (sectionType === 'image') {
            const url = section.querySelector('.sec-url').value.trim();
            const caption = section.querySelector('.sec-caption').value.trim();
            if (url) {
                contentHTML = `
                    <div style="margin-bottom: 25px;">
                        <h2>${title}</h2>
                        <div class="image-container" style="text-align:center;">
                            <img src="${url}" alt="${caption}" style="max-width:100%; height:auto; border-radius:6px; margin-top:8px;">
                            ${caption ? `<p style="font-style:italic; font-size:14px; color:#666;">${caption}</p>` : ''}
                        </div>
                    </div>
                `;
            }
        } else if (sectionType === 'table') {
            const table = section.querySelector('table');
            let tableHTML = '<table>';
            let dataColumnsCount = table.querySelector('thead tr').querySelectorAll('th').length - 1; // Number of data columns

            // Table Header
            const headerRow = table.querySelector('thead tr');
            tableHTML += '<thead><tr>';
            headerRow.querySelectorAll('th').forEach((th, index) => {
                if (index < dataColumnsCount) { 
                     // Use the current input value as the final header text
                    const headerText = th.querySelector('input') ? th.querySelector('input').value : th.innerText;
                    tableHTML += `<th>${headerText}</th>`;
                }
            });
            tableHTML += '</tr></thead>';

            // Table Body
            tableHTML += '<tbody>';
            let hasContent = false;
            table.querySelectorAll('tbody tr').forEach(row => {
                let rowData = [];
                let rowHasContent = false;
                // Only iterate through data columns
                for(let i = 0; i < dataColumnsCount; i++) {
                    const td = row.querySelectorAll('td')[i];
                    if (td) {
                        const cellContent = td.querySelector('input') ? td.querySelector('input').value.trim() : td.innerText.trim();
                        rowData.push(`<td>${cellContent}</td>`);
                        if (cellContent !== '') {
                            rowHasContent = true;
                        }
                    }
                }
                
                // Only include rows that have content (i.e., not just empty starter rows)
                if (rowHasContent) {
                     tableHTML += `<tr>${rowData.join('')}</tr>`;
                     hasContent = true;
                }
            });
            tableHTML += '</tbody></table>';

            // Wrap table output only if it contains data
            if (hasContent) {
                contentHTML = `
                    <div style="margin-bottom: 25px;">
                        <h2>${title}</h2>
                        ${tableHTML}
                    </div>
                `;
            }
        } else if (sectionType === 'buttons') {
            const buttonRows = document.getElementById('actionButtonsContainer').querySelectorAll('div');
            let buttonLinks = [];
            buttonRows.forEach(row => {
                const label = row.querySelector('.btn-label')?.value.trim();
                const url = row.querySelector('.btn-url')?.value.trim();
                if (label && url) {
                    buttonLinks.push({ label, url });
                }
            });
            
            if (buttonLinks.length > 0) {
                // Apply the CTA block look
                const buttonsHtml = buttonLinks.map(b => `<a href="${b.url}" target="_blank" class="apply-button">${b.label}</a>`).join('');
                contentHTML = `
                    <div style="margin-bottom: 25px;">
                        <h2>${title}</h2>
                        <div class="action-button-group">
                            ${buttonsHtml}
                        </div>
                    </div>
                `;
            }
        } 

        previewContent += contentHTML;
    });

    if (previewContent.length < 200) { 
        return `
            <div style="text-align: center; padding: 50px; background: #fff; border: 1px dashed #ccc; border-radius: 8px;">
                <h3 style="color:#dc3545;">No content generated yet.</h3>
                <p>Add some sections above and click 'Preview' again!</p>
            </div>
        `;
    }

    // APPEND THE UNIVERSAL FOOTER
    previewContent += UNIVERSAL_FOOTER;

    return previewContent;
}


// Function to render the preview
function previewPost() {
    const previewDiv = document.getElementById('preview');
    
    previewDiv.innerHTML = generatePostContent(false);

    if (previewDiv.classList.contains('hidden')) {
        previewDiv.classList.remove('hidden');
        // Smooth scroll to preview area
        previewDiv.scrollIntoView({ behavior: 'smooth', block: 'start' });
    }
}

// Function to download the final HTML
function downloadHTML() {
    const postTitle = document.getElementById('postTitle').value.trim() || 'untitled-post';
    const postContent = generatePostContent(true);
    
    // Minimal CSS for standalone download: only preview-related styles
    const minimalCSS = `
    <style>
        body { font-family: Arial, sans-serif; background-color: #f8f9fa; line-height: 1.7; color: #333; padding: 20px 0; }
        .post-container { max-width: 1200px; margin: 0 auto; background-color: #f8f9fa; }
        
        /* Post Header Styles */
        .post-header-box { text-align: center; margin-bottom: 30px; padding: 20px; background-color: #007bff; color: white; border-radius: 8px; }
        .post-header-box h1 { font-size: 2.2em; margin: 0 0 10px 0; color: white; }
        
        /* Job Card Section Styles */
        .themed-section { background-color: #ffffff; padding: 20px; border-radius: 8px; box-shadow: 0 4px 8px rgba(0,0,0,0.1); border-left: 5px solid #007bff; margin-bottom: 25px; }
        .themed-section h3 { color: #007bff; margin-top: 0; }
        
        /* General Headings */
        h1{font-size:32px;margin:20px 0 14px 0;font-weight:700;color:#1a1a1a}
        h2 { color: #007bff; border-bottom: 3px solid #007bff; padding-bottom: 10px; margin-top: 40px; margin-bottom: 16px; font-size: 26px; font-weight: 600; }
        h3 { color: #222; font-size: 22px; margin: 16px 0 8px 0; font-weight: 600; }

        /* Text and Lists */
        p, ul, ol, li { line-height: 1.7; color: #333; }
        ul, ol { padding-left: 20px; margin: 10px 0; }
        li { margin-bottom: 8px; }
        
        /* Table Styles */
        table { width: 100%; border-collapse: collapse; margin: 15px 0; }
        th, td { border: 1px solid #ddd; padding: 12px; text-align: left; vertical-align: middle; }
        th { background: #e9f5ff; font-weight: 700; color: #007bff; border-top: 3px solid #007bff; }
        
        /* Action Button (CTA) Styles */
        .action-button-group { text-align: center; margin: 20px 0 10px 0; padding: 15px; background-color: #fff; border: 1px solid #eee; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
        .apply-button { display: inline-block; background: #dc3545; color: #fff; padding: 12px 24px; border-radius: 6px; text-decoration: none; font-weight: 700; margin: 8px; font-size: 16px; transition: all 0.2s; }
        .apply-button:hover { background: #c82333; }

        /* General Link Styles */
        a { color: #007bff; text-decoration: none; }
        a:hover { text-decoration: underline; }
    </style>`;

    const fullHTML = `
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>${postTitle}</title>
    ${minimalCSS}
</head>
<body>
    <div class="post-container">
        ${postContent}
    </div>
</body>
</html>
    `;

    const blob = new Blob([fullHTML], { type: 'text/html' });
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = `${postTitle.replace(/[^a-z0-9]/gi, '_').toLowerCase()}.html`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(a.href);
}


// --- INITIALIZATION & EVENT HANDLERS ---
(function init(){
    // Initialize default buttons
    let buttonsContainer = document.getElementById('actionButtonsContainer');
    if (buttonsContainer && buttonsContainer.children.length === 0) {
        addActionButton('Click Here to Apply Online','https://example.com/apply');
    }
    
    // Attach event listeners to default sections (Crucial for toolbar state)
    document.querySelectorAll('.rich-editor').forEach(e => {
        // These listeners are only for updating the button's active state (not selection management)
        e.addEventListener('keyup', () => updateToolbarState(e));
        e.addEventListener('mouseup', () => updateToolbarState(e));
    });
    
    // Paste handler for rich editors (Kept cleanup logic):
    document.addEventListener('paste',function(e){
        const t=e.target;
        if(t.classList && t.classList.contains('rich-editor')){
            e.preventDefault();
            const h=e.clipboardData.getData('text/html');
            const tx=e.clipboardData.getData('text/plain');
            
            if(h){
                const tm=document.createElement('div');
                tm.innerHTML=h;
                tm.querySelectorAll('*').forEach(el => {
                    if(el.tagName === 'STYLE' || el.tagName === 'SCRIPT') { el.remove(); }
                    el.removeAttribute('style');
                    el.removeAttribute('class');
                });
                document.execCommand('insertHTML',false,tm.innerHTML);
            } else {
                document.execCommand('insertText',false,tx);
            }
        }
    });
    
    // Close clone dropdown on outside click:
    document.addEventListener('click', (e) => {
        const dropdown = document.getElementById('cloneDropdown');
        // The clone button is the parent of the dropdown
        const cloneButton = document.querySelector('[onclick*="cloneSectionDialog"]'); 
        
        if (dropdown && !dropdown.contains(e.target) && e.target !== cloneButton) {
            dropdown.remove();
        }
    });
})();
</script>
</body>
</html>